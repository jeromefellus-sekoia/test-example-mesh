name: wiz-vulnerability-findings
pipeline:
  - name: json_event
    external:
      name: json.parse-json
      properties:
        input_field: "{{original.message}}"
        output_field: message

  - name: parsed_first_detected_at
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.firstDetectedAt}}"
        output_field: datetime

  - name: parsed_resolved_at
    external:
      name: date.parse
      properties:
        input_field: "{{json_event.message.resolvedAt}}"
        output_field: datetime

  - name: set_ecs_fields
stages:
  set_ecs_fields:
    actions:
      - set:
          observer.vendor: "Wiz"

          event.kind: "alert"
          event.category: ["vulnerability"]
          event.type: ["info"]
          event.dataset: "Vulnerability Finding"

          "@timestamp": "{{parsed_first_detected_at.datetime}}"
          event.start: "{{parsed_first_detected_at.datetime}}"
          event.end: "{{parsed_resolved_at.datetime}}"

          vulnerability.id: "{{json_event.message.id}}"
          vulnerability.reference: "{{json_event.message.portalUrl}}"
          vulnerability.description: "{{json_event.message.CVEDescription}}"
          vulnerability.severity: "{{json_event.message.severity}}"
          vulnerability.score.base: "{{json_event.message.cnaScore}}"

          log.level: "{{json_event.message.severity}}"

          wiz.vulnerability.status: "{{json_event.message.status}}"
          wiz.vulnerability.score.exploitability: "{{json_event.message.exploitabilityScore}}"
          wiz.vulnerability.score.impact: "{{json_event.message.impactScore}}"
          wiz.vulnerability.hasExploit: "{{json_event.message.hasExploit}}"

          host.id: "{{json_event.message.vulnerableAsset.id}}"
          host.type: "{{json_event.message.vulnerableAsset.type}}"
          host.name: "{{json_event.message.vulnerableAsset.name}}"
          host.os.name: "{{json_event.message.vulnerableAsset.operatingSystem}}"

          cloud.provider: "{{json_event.message.vulnerableAsset.cloudPlatform}}"
          cloud.region: "{{json_event.message.vulnerableAsset.region}}"
          cloud.instance.id: "{{json_event.message.vulnerableAsset.providerUniqueId}}"
          cloud.instance.name: "{{json_event.message.vulnerableAsset.name}}"
          cloud.project.id: "{{json_event.message.vulnerableAsset.subscriptionId}}"
          cloud.project.name: "{{json_event.message.vulnerableAsset.subscriptionName}}"

          user.name: "{{json_event.message.vulnerableAsset.tags.Owner}}"

      - set:
          host.ip: "{{json_event.message.vulnerableAsset.ipAddresses[0]}}"
        filter: "{{json_event.message.vulnerableAsset.get('ipAddresses', []) != []}}"
